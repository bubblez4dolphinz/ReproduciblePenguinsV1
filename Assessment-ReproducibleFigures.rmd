---
title: "Assessment - Reproducible Penguin Figures"
output:
  html_document: default
  toc: true
  toc_float: true
  theme: journal
---

```{r setup-rmd, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set up

Initialise R environment, set working directory, clear workspace, load in functions and packages, and set plot theme.

```{r setup-renv, message = FALSE, warning = FALSE}
renv::init() #initialise renv
```

```{r setup-wd and clear workspace, message = FALSE, warning = FALSE}
setwd(".") #set working directory to where the file is saved
rm(list = ls(all.names = TRUE)) #clear workspace
```

```{r functions, message = FALSE, warning = FALSE}
# Load the functions
source("functions/cleaning.r")
source("functions/packages.r")
```

```{r Install and load packages, message = FALSE, warning = FALSE}
# Install and load packages as required
packages <- c("palmerpenguins", "tidyverse", "janitor", "broom", "svglite", "cowplot", "gridExtra")
check_and_load_packages(packages)
```

```{r setup-standardise plots, message = FALSE, warning = FALSE}
theme_set(theme_minimal()) #I want all the plots to be the same theme
```

------------------------------------------------------------------------
## QUESTION 01: Data Visualisation for Science Communication

*Create a figure using the Palmer Penguin dataset that is correct but badly communicates the data.*

-   [*https://www.nature.com/articles/533452a*](https://www.nature.com/articles/533452a){.uri}
-   [*https://elifesciences.org/articles/16800*](https://elifesciences.org/articles/16800){.uri}

### a) Provide your figure here:

```{r bad figure code, echo=FALSE}
mean_bd <- aggregate(bill_depth_mm ~ sex, data = penguins, FUN = mean, na.rm = TRUE)

ggplot(mean_bd, aes(x="", y=log(bill_depth_mm), fill=sex)) +
  geom_bar(stat = "identity", position = "stack", width=0.1) +
  scale_fill_manual(values=c("red", "darkgreen"))+
  labs(title="log(mean bill depth) of each sex", x="Penguins", y="log(mean bill depth) (mm)") +
  coord_flip() +
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
```

### b) Write about how your design choices mislead the reader about the underlying data (200-300 words).

I have plotted a stacked bar chart showing the log of the mean bill depth for each sex. The means are calculated and plotted accurately but they are obscured by the log scale, stacking, non-colour-blind friendly colouring, horizontal display, and lack of grid lines. Wong (2013) emphasises the importance of doing the work for the reader allowing them to "make a judgement at a glance"; this is certainly not the case with my chart. Bar charts are best used for count data and, while they can be used for means, a strip plot with the mean highlighted would have been better. If kept as a bar chart, it should be vertical, have two separate bars of the same colour, with natural (non-logged) y-axis scaling. Additionally, it is best practice to include error bars showing the standard deviation around the mean and label the bars with sample sizes. These changes would help correct for the fact that the mean as a single statistic can be misleading and so presenting it with context allows the reader to interpret it correctly. Moreover, the biological logic of plotting bill depth against sex for all species is flawed. While there may be sexual dimorphism within species, we may not expect a consistent pattern across species and means may be skewed by interspecific differences. Other than sex, body mass may correlate with bill depth but, again, plotting all species together as a linear model (bill_length \~ body_mass) would give a misleading negative relationship, which is reversed when species are included. This is a case of Simpson's paradox (Horst et al 2022). The lesson to be learned is the importance of investigating species differences before trying to compare some features whose relationship with the response variable may differ between species.

*References.* 
Horst, A.M., Hill, A.P. and Gorman, K.B., 2022. Palmer Archipelago Penguins Data in the palmerpenguins R Package-An Alternative to Anderson's Irises. R Journal, 14(1).

Wong, D.M., 2013. The Wall Street Journal guide to information graphics: The dos and don'ts of presenting data, facts, and figures. WW Norton & Company.

Ataccama. (2022, August 12). Top 10 Takeaways from WSJ Guide to Information Graphics. Ataccama. <https://www.ataccama.com/blog/top-10-takeaways-from-wsj-guide-to-information-graphics>

Elsinghorst, S. (2020, October 20). The Good, the Bad and the Ugly: how (not) to visualize data. Shirin's playgRound. <https://shirinsplayground.netlify.app/2020/10/goodbadugly/>

------------------------------------------------------------------------

## QUESTION 2: Data Pipeline

*Write a data analysis pipeline in your .rmd RMarkdown file. You should be aiming to write a clear explanation of the steps as well as clear code.*

*Your code should include the steps practiced in the lab session:*

-   *Load the data*
-   *Appropriately clean the data*
-   *Create an Exploratory Figure (**not a boxplot**)*
-   *Save the figure*
-   ***New**: Run a statistical test*
-   ***New**: Create a Results Figure*
-   *Save the figure*


### Introduction

##### I. Loading the data

```{r Read in data}
if (!dir.exists("data")) {
  dir.create("data")
}

write.csv(penguins_raw, "data/penguins_raw.csv")
```

This creates a csv file called penguins_raw from the dataset called the same thing in the Palmer penguins package. It is saving it in a folder in the working directory called data.

##### II. Cleaning the data

```{r Clean data}
penguins_clean <- cleaning_penguins(penguins_raw)
write.csv(penguins_clean, "data/penguins_clean.csv")
```

We could cope without cleaning the names but having no spaces means we don't have to use \`column name\` formatting and standardizing it means it is easier to start typing the right thing so R can suggest the completion. Overall, it is neater and easier to work with now.

##### III. Creating an exploratory figure

```{r Data Exploration figure}
exploratory_fig <- ggplot(na.omit(penguins_clean), aes(x = sex, y = body_mass_g, colour=sex)) +
  geom_jitter(width = 0.2, height = 0) +
  facet_wrap(vars(species), ncol = 3) +
  labs(title="Relationship of sex and species to body mass", x="Species", y="Body mass (g)") +
  scale_x_discrete(labels = c("FEMALE" = "F", "MALE" = "M")) +
  scale_color_brewer(palette = "Set1") +
  theme(legend.position = "bottom")
exploratory_fig
```

I plotted a jitter plot splitting the penguins by sex and species to see if any within or between species patterns emerged. It does seem that generally across species the males weigh more and the Gentoos weigh more than either Adelies or Chinstraps. Moreover, the discrepancy between sexes seems larger in Adelies and Gentoos than in Chinstraps so, I propose that there is an interaction there between sex and species.

##### IV. Saving the exploratory figure

```{r Saving exploratory figure}
if (!dir.exists("figures")) {
  dir.create("figures")
}

svglite("figures/fig01_exploratory.svg", 
        width = 5.9, height = 5.9) #saving figure to wd
exploratory_fig
while (!is.null(dev.list()))  dev.off()
```

### Hypotheses

Looking just at Chinstrap and Gentoo, I hypothesize that there will be significant effects of both species and sex on body mass and also that there will be a significant interaction of species and sex.

-   H0.1: There is no difference in mean body mass between species
-   H1.1: There is a significant difference in mean body mass between species
-   H0.2: There is no difference in mean body mass between sexes
-   H1.1: There is a significant difference in mean body mass between sexes
-   H0.3: There is no interaction between sex and species
-   H1.3: There is a significant interaction between species and sex

### Statistical Methods

##### I. Fitting the linear model

```{r Statistics - model and assumptions}
rm.adelie <- penguins_clean %>%
  filter(!species == "Adelie") #removing adelie species

#Fitting the linear model
bm_factors <- lm(body_mass_g ~ species*sex, rm.adelie)
```

Firstly, for this analysis I just wanted to only compare Chinstrap and Gentoo penguins so I used the dplyr 'filter()' function to remove the Adelie penguins.

I fitted a full linear model proposing that body mass is affected by species, sex and the interaction between the two. i.e. Body mass \~ mu + Species + Sex + Species\*Sex.

##### II. Checking assumptions

###### i. Normality

```{r Testing assumptions1}
### checking normality assumption [2] with resid vs fitted plot and a normal qqplot
par(mfrow = c(1, 2))
plot(bm_factors, which = 1)
plot(bm_factors, which = 2)
```
^Both plots are consistent with the normality assumption [see below for explanation] 

###### ii. Equal variance

```{r Testing assumptions2}
### checking equal variance assumption [3] with F test
var.test(body_mass_g ~ species, rm.adelie, alternative = "two.sided")
var.test(body_mass_g ~ sex, rm.adelie, alternative = "two.sided")
```
^Both results are consistent with the equal variance assumption [see below for explanation]

Before going ahead with analysis on the linear model I needed to check the validity of the assumptions.

1.  As far as I'm aware the penguins in the dataset were sampled randomly from their populations
2.  Body mass must be normally distributed within groups (sex and species). I plotted both a residuals vs fitted plot and a normal qqplot to check this. The model's residuals are evenly distributed above and below the normal line and the real data maps very well to the theoretical quantiles with only minor deviation at the extremes. I am satisfied that the normality assumption hasn't been violated.
3.  The last assumption is that variance is equal between the groups. I used the F-test (var.test) to test the null assumption that there was not a significant difference between the groups and it was insignificant for both species (p-value=0.5812) and sexes (p-value=0.5908) so the data doesn't violate the equal variance assumption. So, we can go ahead with fitting a linear model.

### Results & Discussion

##### I. Results of ANOVA

```{r Model outputs and ANOVA results}
summary(bm_factors) #summary table of model outputs
anova(bm_factors) #results of running an anova test
```

**First:** The Adjusted R squared is 0.8519, meaning that our model can explain 85% of all the variation seen. This is very high and gives the model biological significance to accompany the statistical significance reflected in the large F-statistic (357.6) and very small p-value (\<2.2e-16 \<\< 0.05).

**Second:** Interpreting the coefficients table

-   row 1 is the mean body mass Female Chinstraps (=3527.21g)
-   row 2 is the difference between mean mass of Female Gentoos and Chinstraps. So, Female Gentoos are (3527.21 + 1152.54 =4679.75g)
-   row 3 is the difference between mean mass of Male and Female Chinstraps. So, Male chinstraps are (3527.21 + 411.76 =3938.97g)
-   row 4 was the expected difference between mean mass of Male Gentoos and Female Chinstraos if there were to be no interaction. so, to get the mean for Male Gentoos we have to add all the rows (3527.21 + 1152.54 + 411.76 + 393.33 =5484.84)

**Third:** The ANOVA table shows that species (\< 2.2e-16), sex (\< 2.2e-16) and the interaction (4.285e-05) are all significant so we have sufficient evidence to reject all three null hypotheses. This means we do not have to simplify the model. Lastly, the F value is largest (840.10) for species so, that is our main effect. The interaction has the smallest F value (17.58) so it is a minor but significant effect.


##### II. Post-hoc pairwise comparison test

```{r Post-hoc test}
#post-hoc Tukey test
TukeyHSD(aov(bm_factors))
```

I ran an post hoc test, the Tukey-Kramer test to work out which groups were different from each other. It turns out they all were (all the adj p-values were \< 0.05) but particularly significant seems to be the comparison between Gentoo Males and Females which makes sense given our exploratory and interaction plots.


##### III. Making an interaction plot

```{r Plotting Results}
#Making an interaction plot
interaction_plot <- ggplot(na.omit(rm.adelie), aes(x = species, y = body_mass_g, color = sex)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_line(aes(group = sex), position = position_dodge(width = 0.5)) +
  labs(title="Interaction Plot of Body Mass by Species and Sex with ANOVA results table", x = "Species", y = "Body Mass (g)", color = "Sex") 

#extracting info from anova table
anova_result <- aov(bm_factors)
anova_df <- tidy(anova_result)  %>% 
  select(-df, -sumsq, -meansq) %>% 
  filter(term != "Residuals") %>%
  rename("F.value" = "statistic")

table_grob <- tableGrob(anova_df)

Interaction_plot_combo <- plot_grid(interaction_plot, table_grob, nrow = 1)

Interaction_plot_combo
```

From the interaction plot, it makes sense that we saw a major effect of species and a smaller effect of sex. The sex difference we did see was probably largely driven by the Gentoos. The slopes are different which is consistent with the significant interaction (species:sex) term. It makes sense that the interaction effect is relatively small however as the slopes are not massively different.


##### IV. Saving the interaction plot

```{r Saving results figure}
svglite("figures/fig02_results.svg", 
        width = 5.9, height = 5.9) #saving figure to wd
Interaction_plot_combo
while (!is.null(dev.list()))  dev.off()
```


### Conclusion

The results of my ANOVA analysis reveal what I suspected from the exploratory plot that when comparing Chinstrap and Gentoo penguins there would be significant effects on body mass of both species and sex as well as a significant interaction between the two. The full linear model I fitted had very high explanatory power (R-squared = 0.815) and statistical signficance (p\<2.2e-16). This makes biological sense because we would expect body mass to differ between species as a consequence of evolving in different niches. Also, its possible that body mass contributes to sexual dimorphism within species but that pattern is unlikely to overpower interspecific differences. For instance, in the explanatory plot we see that Gentoo females are larger than most Adelie and Chinstrap males. Also, it is likely that the extent of sexual dimorphism would differ between species and features other than body mass would be under sexual selection pressure. To extend this research, I suggest investigating the influence of location (i.e. home island) on body mass. It is possible that the species differences we have seen is down to island preference. Some islands could support bigger animals of whatever species finds itself there. Moreover, this could be complicated if the species compete such that Chinstraps and Adelie may reach bigger sizes in the absence of large Gentoos. Further explanatory plots followed by statistical analysis could contribute to fully deciphering the patterns of body mass across these species of penguins.

------------------------------------------------------------------------

## QUESTION 3: Open Science

### a) GitHub

*Upload your RProject you created for **Question 2** and any files and subfolders used to GitHub. Do not include any identifiers such as your name. Make sure your GitHub repo is public.*

*GitHub link:*

*You will be marked on your repo organisation and readability.*

### b) Share your repo with a partner, download, and try to run their data pipeline.

*Partner's GitHub link:*

*You **must** provide this so I can verify there is no plagiarism between you and your partner.*

### c) Reflect on your experience running their code. (300-500 words)

-   *What elements of your partner's code helped you to understand their data pipeline?*

-   *Did it run? Did you need to fix anything?*

-   *What suggestions would you make for improving their code to make it more understandable or reproducible, and why?*

-   *If you needed to alter your partner's figure using their code, do you think that would be easy or difficult, and why?*

### d) Reflect on your own code based on your experience with your partner's code and their review of yours. (300-500 words)

-   *What improvements did they suggest, and do you agree?*

-   *What did you learn about writing code for other people?*
